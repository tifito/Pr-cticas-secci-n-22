/*Crear un procedimiento denominado “notas_max_mix” que tenga un
curso que extraiga las notas máximas y mínimas de cada curso. Deben
poner también el nombre del curso, pero deben extraerlo por fuera del
cursor. Hacerlo con un bucle WHILE
*/






delimiter //
drop procedure if exists notas_max_min//   -- Elimina el procedimiento si ya existe, para evitar errores al crearlo otra vez
CREATE procedure notas_max_min()
BEGIN
 declare fin boolean;                      -- Variable para saber cuándo termina el cursor
 declare v_nombre varchar(50);             -- Guarda el nombre del curso
 declare v_cod_curso int;                  -- Guarda el código del curso
 declare v_nota_max decimal;               -- Guarda la nota más alta del curso
 declare v_nota_min decimal;               -- Guarda la nota más baja del curso
 declare salida text;                      -- Variable donde se va armando el texto final con los resultados

 declare cursor_notas cursor for select    -- Cursor que obtiene por cada curso la nota máxima y mínima
 cod_curso,max(nota),min(nota) from notas_alumnos group by cod_curso;

 declare continue handler for not found set fin=true;  -- Cuando ya no hay más filas, activa la variable fin

 set salida=' ';                           -- Inicializa la variable salida vacía
 set fin=false;                            -- Marca que todavía no ha terminado el cursor

 open cursor_notas;                        -- Abre el cursor para empezar a recorrer los datos

 eti1: loop                                -- Inicio del bucle que recorre los resultados del cursor
 fetch cursor_notas into v_cod_curso,v_nota_max,v_nota_min;  -- Pasa los valores de cada fila a las variables
 if fin then                               -- Si ya no hay más filas
 leave eti1;                               -- Sale del bucle
end if;

 select nombre into v_nombre from cursos where cod_curso=v_cod_curso;  -- Busca el nombre del curso según el código

 set salida=concat(salida,'\n', v_nombre,' ',v_nota_max,' ',v_nota_min); -- Junta todo en una cadena con el nombre y notas

 end loop;                                -- Fin del bucle
 close cursor_notas;                      -- Cierra el cursor
 select salida;                           -- Muestra todo el texto con los resultados
end//
-- Probar el procedimiento
call notas_max_min()//                    -- Llama al procedimiento para ejecutarlo
